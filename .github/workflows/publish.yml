name: Publish PowerShell Module

on:
  # This workflow only runs when a GitHub Release is *published*.
  # Practical meaning:
  # - Draft releases do NOT trigger this workflow.
  # - Editing an existing release does NOT trigger this workflow.
  # - Clicking "Publish release" in GitHub *does* trigger this workflow.
  #
  # Why we care:
  # - A release is our "official" version marker.
  # - The release tag (e.g., v1.2.3) becomes the PowerShell module version.
  release:
    types: [published]

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare module version
        shell: pwsh
        run: |
          # Update manifest with dynamic data from the GitHub release:
          # - ModuleVersion from release tag (e.g., v1.2.3 → 1.2.3).
          # - Prerelease suffix if present (e.g., v1.2.3-preview1).
          # - FunctionsToExport discovered from Public/*.ps1 files.
          # - ReleaseNotes extracted from GitHub release description.
          ./scripts/Update-ModuleManifest.ps1

      - name: Stage README for PowerShell Gallery
        shell: pwsh
        run: |
          # Include README.md in the module package for consumers who download it.
          # Copy the repo README into the module folder so it is packaged and published.
          Copy-Item -Path ./README.md -Destination ./OneNoteAutomation/README.md -Force

      - name: Publish module to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          # The API key must be configured as a GitHub Actions secret:
          # Settings → Secrets and variables → Actions → New repository secret.
          # Without it, publishing will fail (by design).
          if (-not $env:PSGALLERY_API_KEY) {
            throw 'PSGALLERY_API_KEY secret is not set.'
          }

          # Publish-Module packages the module from the path and pushes it to PSGallery.
          # The version used is the one we wrote into the manifest above.
          Publish-Module -Path ./OneNoteAutomation -NuGetApiKey $env:PSGALLERY_API_KEY -Repository PSGallery
